---
# SPDX-License-Identifier: EUPL-1.2
# SPDX-FileCopyrightText: 2025-present JÃ¼rgen MÃ¼lbert <juergen.muelbert@gmail.com>

name: Push Analysis

# yamllint disable-line rule:truthy
on:
  push:
    branches:
      - main
      - develop
    paths-ignore:
      - "**.md"
      - docs/**
      - .gitignore

defaults:
  run:
    shell: bash

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  analyze-push:
    name: Analyze Push
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ”’ Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: ðŸ§° Checkout Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 2

      - name: Install commitlint
        run: npm install -D @commitlint/cli @commitlint/config-conventional
      - name: Print versions
        run: |
          git --version
          node --version
          npm --version
          npx commitlint --version

      - name: Validate current commit (last commit) with commitlint
        if: github.event_name == 'push'
        run: npx commitlint --last --verbose

      - name: Validate PR commits with commitlint
        if: github.event_name == 'pull_request'
        run: npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose

      - name: Malcontent GitHub Action
        id: malcontent
        uses: chainguard-dev/malcontent-action@053384afe0bb069ba7e2996bd8c0863731406002 # v0.4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          fail-on-increase: false # Handle manually based on risk delta

      - name: Check risk delta
        run: |
          echo "Risk changed by: ${{ steps.malcontent.outputs.risk-delta }} points"
          if [[ "${{ steps.malcontent.outputs.risk-increased }}" == "true" ]]; then
            echo "âš ï¸ Security risk increased!"
          fi

      # Fail only on significant risk increase (>10 points)
      - name: Evaluate risk threshold
        if: steps.malcontent.outputs.risk-delta > 10
        run: |
          echo "::error::Significant security risk increase detected!"
          exit 1

      # Or use different thresholds for different actions
      - name: Request security review
        if: steps.malcontent.outputs.risk-delta > 5 && steps.malcontent.outputs.risk-delta <= 10
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['security-review']
            })

      - name: ðŸ“¤ Upload to maleware-scanning
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
        if: always() # Upload even if the malcontent check fails
        with:
          sarif_file: ${{ steps.malcontent.outputs.sarif-file }}
          category: malcontent

      - name: ðŸ”„ Check Merge Conflicts
        id: conflicts
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const pr = context.payload.pull_request;
            if (pr.mergeable === false) {
              await github.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['merge-conflict']
              });
            }
