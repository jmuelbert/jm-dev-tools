---
# SPDX-License-Identifier: EUPL-1.2
# SPDX-FileCopyrightText: 2025-present JÃ¼rgen MÃ¼lbert <juergen.muelbert@gmail.com>

name: Pull Request Automation

# yamllint disable-line rule:truthy
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]
    paths-ignore:
      - "**.md"
      - docs/**
      - .gitignore

defaults:
  run:
    shell: bash

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  commit-lint:
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: read # For checkout
    steps:
      - name: ðŸ”’ Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: ðŸ§° Checkout Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Setup node
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: lts/*
          cache: npm

      - name: Install commitlint
        run: npm install -D @commitlint/cli @commitlint/config-conventional
      - name: Print versions
        run: |
          git --version
          node --version
          npm --version
          npx commitlint --version

      - name: Validate current commit (last commit) with commitlint
        if: github.event_name == 'push'
        run: npx commitlint --last --verbose

      - name: Validate PR commits with commitlint
        if: github.event_name == 'pull_request'
        run: npx commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose

  malcontent:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write # FÃ¼r addLabels
      pull-requests: write # Falls es ein PR-Kontext ist
      security-events: write # FÃ¼r upload-sarif

    steps:
      - name: ðŸ”’ Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: ðŸ§° Checkout Repository
        id: checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 2 # Need HEAD and HEAD~1

      - name: Malcontent GitHub Action
        id: malcontent
        uses: chainguard-dev/malcontent-action@053384afe0bb069ba7e2996bd8c0863731406002 # v0.4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          fail-on-increase: false # Handle manually based on risk delta

      - name: Check risk delta
        run: |
          echo "Risk changed by: ${{ steps.malcontent.outputs.risk-delta }} points"
          if [[ "${{ steps.malcontent.outputs.risk-increased }}" == "true" ]]; then
            echo "âš ï¸ Security risk increased!"
          fi

      # Fail only on significant risk increase (>10 points)
      - name: Evaluate risk threshold
        if: steps.malcontent.outputs.risk-delta > 10
        run: |
          echo "::error::Significant security risk increase detected!"
          exit 1

      # Or use different thresholds for different actions
      - name: Request security review
        if: steps.malcontent.outputs.risk-delta > 5 && steps.malcontent.outputs.risk-delta <= 10
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['security-review']
            })

  analyze-pr:
    name: Analyze and Manage Pull Request
    if: github.event_name == 'pull_request' && github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write
      issues: write
      security-events: read

    steps:
      - name: ðŸ”’ Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: ðŸ§° Checkout Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: Malcontent GitHub Action
        id: malcontent
        uses: chainguard-dev/malcontent-action@053384afe0bb069ba7e2996bd8c0863731406002 # v0.4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¤ Upload to maleware-scanning
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v4.31.9
        if: always() # Upload even if the malcontent check fails
        with:
          sarif_file: ${{ steps.malcontent.outputs.sarif-file }}
          category: malcontent

      - name: ðŸ”„ Check Merge Conflicts
        id: conflicts
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const pr = context.payload.pull_request;
            if (pr.mergeable === false) {
              await github.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['merge-conflict']
              });
            }

      - name: ðŸ·ï¸ Apply Scope Labels
        id: labeler
        uses: actions/labeler@634933edcd8ababfe52f92936142cc22ac488b1b # v6.0.1
        timeout-minutes: 5
        continue-on-error: true
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/config/labeler.yml
          sync-labels: true

      - name: ðŸ“ Run PR Automation Script
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        id: pr-script
        env:
          MIN_COVERAGE: 51
        with:
          script: |
            const script = require('./.github/scripts/pr-automation.js');
            await script.default({ github, context}  });

  dependency-review:
    name: Dependency Review
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ðŸ”’ Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: ðŸ§° Checkout Repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Dependency Review
        id: review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        with:
          # This action now runs with the goal of generating output for the report
          comment-summary-in-pr: false
          retry-on-snapshot-warnings: true
          config-file: .github/config/dependency-review-config.yml

      - name: ðŸ“Š Generate and Post Report
        if: always()
        env:
          DEPENDENCY_CHANGES: ${{ steps.review.outputs.dependency-changes }}
          VULNERABLE_CHANGES: ${{ steps.review.outputs.vulnerable-changes }}
          LICENSE_CHANGES: ${{ steps.review.outputs.invalid-license-changes }}
          DENIED_CHANGES: ${{ steps.review.outputs.denied-changes }}
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const script = require('./.github/scripts/dependency-report.js');
            await script.default({
              github,
              context
            });
