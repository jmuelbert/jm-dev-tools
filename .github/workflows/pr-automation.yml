---
# SPDX-License-Identifier: EUPL-1.2
# SPDX-FileCopyrightText: 2025-present JÃ¼rgen MÃ¼lbert <juergen.muelbert@outlook.de>

name: Pull Request Automation

# yamllint disable-line rule:truthy
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]
    paths-ignore:
      - "**.md"
      - docs/**
      - .gitignore

defaults:
  run:
    shell: bash

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  commit-lint:
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      contents: read # For checkout
    steps:
      - name: ðŸ”’ Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: ðŸ§° Checkout Repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 0

      # - name: ðŸ“ Lint Commit Messages
      #   uses: conventional-changelog/commitlint-action@v4

  analyze-pr:
    name: Analyze and Manage Pull Request
    if: github.event_name == 'pull_request' && github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: ðŸ”’ Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: ðŸ§° Checkout Repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          fetch-depth: 0

      # - name: ðŸ”„ Check Merge Conflicts
      #   id: conflicts
      #   uses: eps1lon/actions-label-merge-conflict@v3
      #   # e62d7a53ff8be8b97684bffb6cfbbf3fc1115e2e # v3.0.0
      #   timeout-minutes: 5
      #   continue-on-error: true
      #   with:
      #     dirtyLabel: "status: has-conflicts"
      #     repoToken: ${{ secrets.GITHUB_TOKEN }}
      #     commentOnDirty: |
      #       âš ï¸ This pull request has conflicts with the target branch. Please resolve the conflicts by following these steps:
      #       1. Fetch the latest changes.
      #       2. Merge the target branch into your branch.
      #       3. Resolve the conflicts.
      #       4. Push the changes back.

      #       Need help? Check the [Contributing Guide](../../CONTRIBUTING.md) or ask for assistance.
      #     commentOnClean: |
      #       âœ… All conflicts have been resolved. A maintainer will review your PR shortly.

      - name: ðŸ”„ Check Merge Conflicts
        id: conflicts
        uses: actions/github-script@v6
        with:
          script: |
            const pr = context.payload.pull_request;
            if (pr.mergeable === false) {
              await github.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['merge-conflict']
              });
            }

      # - name: ðŸ“ Analyze Pull Request Size
      #   id: size
      #   uses: codelytv/pr-size-labeler@v1
      #   # 1c3422395d899286d5ee2c809fd5aed264d5eb9b # v1.10.2
      #   timeout-minutes: 5
      #   continue-on-error: true
      #   with:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     xs_label: size/xs
      #     xs_max_size: "10"
      #     s_label: size/s
      #     s_max_size: "100"
      #     m_label: size/m
      #     m_max_size: "500"
      #     l_label: size/l
      #     l_max_size: "1000"
      #     xl_label: size/xl
      #     fail_if_xl: false
      #     message_if_xl: |
      #       âš ï¸ This PR is quite large (over 1000 lines). Please consider:
      #       - Breaking it into smaller, focused PRs
      #       - Ensuring all changes are related and well-documented
      #       - Adding detailed documentation for reviewers

      #       Large PRs may require additional review time and scrutiny.
      #     files_to_ignore: |
      #       **/test/**
      #       **/tests/**
      #       **/doc/**
      #       **/docs/**
      #       **/*.md
      #       package-lock.json
      #       pnpm-lock.yaml
      #       uv.lock
      #       poetry.lock

      - name: ðŸ·ï¸ Apply Scope Labels
        id: labeler
        uses: actions/labeler@634933edcd8ababfe52f92936142cc22ac488b1b # v6.0.1
        timeout-minutes: 5
        continue-on-error: true
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/config/labeler.yml
          sync-labels: true

      - name: ðŸ“ Run PR Automation Script
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        id: pr-script
        env:
          MIN_COVERAGE: 51
        with:
          script: |
            const script = require('./.github/scripts/pr-automation.js');
            await script.default({ github, context, min_coverage: env.MIN_COVERAGE });

  dependency-review:
    name: Dependency Review
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: ðŸ”’ Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: ðŸ§° Checkout Repository
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1

      - name: Dependency Review
        id: review
        uses: actions/dependency-review-action@3c4e3dcb1aa7874d2c16be7d79418e9b7efd6261 # v4.8.2
        with:
          # This action now runs with the goal of generating output for the report
          comment-summary-in-pr: false
          retry-on-snapshot-warnings: true
          config-file: .github/config/dependency-review-config.yml

      - name: ðŸ“Š Generate and Post Report
        if: always()
        env:
          DEPENDENCY_CHANGES: ${{ steps.review.outputs.dependency-changes }}
          VULNERABLE_CHANGES: ${{ steps.review.outputs.vulnerable-changes }}
          LICENSE_CHANGES: ${{ steps.review.outputs.invalid-license-changes }}
          DENIED_CHANGES: ${{ steps.review.outputs.denied-changes }}
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const script = require('./.github/scripts/dependency-report.js');
            await script.default({
              github,
              context,
              dep: process.env.DEPENDENCY_CHANGES,
              workspace: process.env.GITHUB_WORKSPACE,
              vul: process.env.VULNERABLE_CHANGES,
              lic: process.env.LICENSE_CHANGES,
              den: process.env.DENIED_CHANGES
            });

  verify:
    needs: [commit-lint, analyze-pr, dependency-review]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸ”’ Harden Runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      # - name: âœ… Verify Workflow Completion
      #   uses: re-actors/alls-green@release/v1
      #   # 05ac9388f0aebcb5727afa17fcccfecd6f8ec5fe
      #   with:
      #     allowed-skips: commit-lint, analyze-pr, dependency-review
      #     jobs: ${{ toJSON(needs) }}

      - name: ðŸŒŸ Add Label on All Green
        uses: actions/github-script@v6
        with:
          script: |
            const pr = context.payload.pull_request;
            const checks = await github.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: pr.head.sha,
            });
            const allGreen = checks.data.check_runs.every(check => check.conclusion === 'success');
            if (allGreen) {
              await github.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['all-green']
              });
            }
